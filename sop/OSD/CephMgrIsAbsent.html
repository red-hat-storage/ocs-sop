<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CephMgrIsAbsent :: OCS Standard Operating Procedures</title>
    <link rel="canonical" href="https://mid998.github.io/ocs-sop/sop/OSD/CephMgrIsAbsent.html">
    <meta name="description" content="Ceph Manager has disappeared from Prometheus target discovery.">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PDMKGVZNGE"></script>
<script>function gtag() { dataLayer.push(arguments) }; window.dataLayer = window.dataLayer || []; gtag('js', new Date()); gtag('config', 'G-PDMKGVZNGE')</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">
          <img src="../../_/img/header_logo_reverse.svg" height="40px" alt="Red Hat Data Services">
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Get Help</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://access.redhat.com/documentation/en-us/red_hat_openshift_container_storage" target="_blank">OCS Documentation</a>
            <a class="navbar-item" href="https://bugzilla.redhat.com/describecomponents.cgi?product=Red%20Hat%20OpenShift%20Container%20Storage" target="_blank">Browse Bugs</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Improve Guides</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/red-hat-storage/ocs-training/blob/master/CONTRIBUTING.adoc" target="_blank">Guidelines</a>
            <a class="navbar-item" href="https://github.com/red-hat-storage/ocs-training/issues/new/choose" target="_blank">Open Issue</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Infos</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://www.redhat.com/en/blog/channel/red-hat-storage" target="_blank">Our Blog</a>
            <a class="navbar-item" href="https://www.youtube.com/channel/UCoyG8VyvB-XUxQl1mD3T3Gw" target="_blank">Youtube</a>
            <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">OCS Technology</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="sop" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html" class=" query-params-link">OCS Standard Operating Procedures</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Alerts (Reviewed SOPs)</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../alerts/CephClusterReadOnly.html">CephClusterReadOnly</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../alerts/CephClusterCriticallyFull.html">CephClusterCriticallyFull</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../alerts/CephOSDCriticallyFull.html">CephOSDCriticallyFull</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../alerts/CephOSDNearFull.html">CephOSDNearFull</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Alerts (Pending Review SOPs)</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../alerts/CephClusterWarningState.html">CephClusterWarningState</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../alerts/CephClusterErrorState.html">CephClusterErrorState</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../alerts/CephMdsMissingReplicas.html">CephMdsMissingReplicas</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../alerts/CephMgrIsAbsent.html">CephMgrIsAbsent</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../alerts/CephMgrIsMissingReplicas.html">CephMgrIsMissingReplicas</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../alerts/CephMonQuorumAtRisk.html">CephMonQuorumAtRisk</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../alerts/CephMonVersionMismatch.html">CephMonVersionMismatch</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../alerts/CephNodeDown.html">CephNodeDown</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../alerts/CephOSDDiskNotResponding.html">CephOSDDiskNotResponding</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../alerts/CephOSDDiskUnavailable.html">CephOSDDiskUnavailable</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../alerts/CephOSDVersionMismatch.html">CephOSDVersionMismatch</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../alerts/CephPGRepairTakingTooLong.html">CephPGRepairTakingTooLong</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Dedicated Alerts</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephClusterCriticallyFull.html">CephClusterCriticallyFull</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephOSDNearFull.html">CephOSDNearFull</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephOSDCriticallyFull.html">CephOSDCriticallyFull</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephOSDDiskUnavailable.html">CephOSDDiskUnavailable</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephOSDDiskNotResponding.html">CephOSDDiskNotResponding</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephNodeDown.html">CephNodeDown</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephMonVersionMismatch.html">CephMonVersionMismatch</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephOSDVersionMismatch.html">CephOSDVersionMismatch</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephMgrIsMissingReplicas.html">CephMgrIsMissingReplicas</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephMdsMissingReplicas.html">CephMdsMissingReplicas</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephClusterReadOnly.html">CephClusterReadOnly</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephClusterWarningState.html">CephClusterWarningState</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephClusterErrorState.html">CephClusterErrorState</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="CephMgrIsAbsent.html">CephMgrIsAbsent</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephMonQuorumAtRisk.html">CephMonQuorumAtRisk</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephPGRepairTakingTooLong.html">CephPGRepairTakingTooLong</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OCS Standard Operating Procedures</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">OCS Standard Operating Procedures</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">OCS Standard Operating Procedures</a></li>
    <li>Dedicated Alerts</li>
    <li><a href="CephMgrIsAbsent.html">CephMgrIsAbsent</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/red-hat-storage/ocs-sop/edit/main/sop/modules/OSD/pages/CephMgrIsAbsent.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">CephMgrIsAbsent</h1>
<div id="preamble">
<div class="sectionbody">
<div id="toc" class="toc">
<div id="toctitle" class="title"><b>Table of Contents</b></div>
<ul class="sectlevel1">
<li><a href="#_check_description">1. Check Description</a></li>
<li><a href="#_overview">2. Overview</a></li>
<li><a href="#_prerequisites">3. Prerequisites</a>
<ul class="sectlevel2">
<li><a href="#_verify_cluster_access">3.1. Verify cluster access</a></li>
<li><a href="#_check_alerts">3.2. Check Alerts</a></li>
<li><a href="#_check_ocs_ceph_cluster_health">3.3. Check OCS Ceph Cluster Health</a></li>
<li><a href="#_further_info">3.4. Further info</a></li>
</ul>
</li>
<li><a href="#_alert">4. Alert</a>
<ul class="sectlevel2">
<li><a href="#_make_change_to_solve_the_alert">4.1. Make change to solve the alert</a></li>
</ul>
</li>
<li><a href="#_troubleshooting">5. Troubleshooting</a></li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_check_description"><a class="anchor" href="#_check_description"></a>1. Check Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Severity:</strong> Warning</p>
</div>
<div class="paragraph">
<p><strong>Potential Customer Impact:</strong> High</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_overview"><a class="anchor" href="#_overview"></a>2. Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ceph Manager has disappeared from Prometheus target discovery.</p>
</div>
<div class="paragraph">
<p></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>3. Prerequisites</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_verify_cluster_access"><a class="anchor" href="#_verify_cluster_access"></a>3.1. Verify cluster access</h3>
<div class="paragraph">
<p>Check the output to ensure you are in the correct context for the cluster mentioned in the alert. If not, please change context and proceed.</p>
</div>
<div class="listingblock execute">
<div class="title">List clusters you have permission to access:</div>
<div class="content">
<pre class="highlightjs highlight"><code>ocm list clusters</code></pre>
</div>
</div>
<div class="paragraph">
<p>From the list above, find the cluster id of the cluster named in the alert. If you do not see the alerting cluster in the list above please contact: WIP</p>
</div>
<div class="listingblock execute">
<div class="title">Grab your credentials and place in kubeconfig:</div>
<div class="content">
<pre class="highlightjs highlight"><code>ocm get /api/clusters_mgmt/v1/clusters/&lt;cluster id&gt;/credentials \
  | jq -r .kubeconfig</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_check_alerts"><a class="anchor" href="#_check_alerts"></a>3.2. Check Alerts</h3>
<div class="listingblock execute">
<div class="title">Get the route to this cluster&#8217;s alertmanager:</div>
<div class="content">
<pre class="highlightjs highlight"><code>MYALERTMANAGER=$(oc -n openshift-monitoring get routes/alertmanager-main --no-headers | awk '{print $2}')</code></pre>
</div>
</div>
<div class="paragraph">
<p>WIP: Separate prometheus stack. Verify route.</p>
</div>
<div class="listingblock execute">
<div class="title">Check all alerts</div>
<div class="content">
<pre class="highlightjs highlight"><code>curl -k -H "Authorization: Bearer $(oc -n openshift-monitoring sa get-token prometheus-k8s)"  https://${MYALERTMANAGER}/api/v1/alerts | jq '.data[] | select( .labels.alertname) | { ALERT: .labels.alertname, STATE: .status.state}'</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_check_ocs_ceph_cluster_health"><a class="anchor" href="#_check_ocs_ceph_cluster_health"></a>3.3. Check OCS Ceph Cluster Health</h3>
<div class="paragraph">
<p>You may directly check OCS Ceph Cluster health by using the rook-ceph toolbox.
.Check and document ceph cluster health:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code>TOOLS_POD=$(oc get pods -n openshift-storage -l app=rook-ceph-tools -o name)
oc rsh -n openshift-storage $TOOLS_POD</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Step 2: From the rsh command prompt, run the following and capture the output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">ceph status
ceph osd status
exit</code></pre>
</div>
</div>
<div class="paragraph">
<p>If 'ceph status' is not in <strong>HEALTH_OK</strong>, please look at the Troubleshooting section to resolve issue.</p>
</div>
</div>
<div class="sect2">
<h3 id="_further_info"><a class="anchor" href="#_further_info"></a>3.4. Further info</h3>
<div class="sect3">
<h4 id="_openshift_data_foundation_dedicated_architecture"><a class="anchor" href="#_openshift_data_foundation_dedicated_architecture"></a>3.4.1. OpenShift Data Foundation Dedicated Architecture</h4>
<div class="paragraph">
<p>Red Hat OpenShift Data Foundation Dedicated (ODF Dedicated) is deployed in converged mode on OpenShift Dedicated Clusters by the OpenShift Cluster Manager add-on infrastructure.</p>
</div>
<div class="ulist">
<div class="title">Related Links</div>
<ul>
<li>
<p><a href="https://docs.google.com/document/d/1ISEY16OfsvEPmlJEjEwPvDvDs0KyNzgl369A-V6-GRA/edit#heading=h.mznotzn8pklp">ODF Dedicated Converged Add-on Architecure </a></p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/red_hat_openshift_container_storage/4.6/html/planning_your_deployment/ocs-architecture_rhocs">ODF Product Architecture</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_alert"><a class="anchor" href="#_alert"></a>4. Alert</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_make_change_to_solve_the_alert"><a class="anchor" href="#_make_change_to_solve_the_alert"></a>4.1. Make change to solve the alert</h3>
<div class="paragraph">
<p>Verify the rook-ceph-mgr pod is failing and restart if necessary. If the ceph mgr pod restart fails, use general basic pod troubleshooting to resolve.</p>
</div>
<div class="listingblock execute">
<div class="title">Verify the ceph mgr pod is failing:</div>
<div class="content">
<pre class="highlightjs highlight"><code>oc get pods | grep mgr</code></pre>
</div>
</div>
<div class="listingblock execute">
<div class="title">Describe the ceph mgr pod for more detail:</div>
<div class="content">
<pre class="highlightjs highlight"><code>oc describe pods/&lt;rook-ceph-mgr pod name from previous step&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Analyze errors (i.e. resource issues?)</p>
</div>
<div class="paragraph">
<p>Try deleting the pod and watch for a successful restart:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code>oc get pods | grep mgr</code></pre>
</div>
</div>
<div class="paragraph">
<p>If above fails, follow general pod troubleshooting procedures.</p>
</div>
<div class="listingblock execute">
<div class="title">pod status: pending &#8594; Check for resource issues, pending pvcs, node assignment, kubelet problems.</div>
<div class="content">
<pre class="highlightjs highlight"><code>oc project openshift-storage
oc get pod | grep rook-ceph-mgr</code></pre>
</div>
</div>
<div class="listingblock execute">
<div class="title">Set MYPOD for convenience:</div>
<div class="content">
<pre class="highlightjs highlight"><code># Examine the output for a rook-ceph-mgr that is in the pending state, not running or not ready
MYPOD=&lt;pod identified as the problem pod&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Look for resource limitations or pending pvcs. Otherwise, check for node assignment.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code>oc get pod/${MYPOD} -o wide</code></pre>
</div>
</div>
<div class="listingblock execute">
<div class="title">pod status: NOT pending, running, but NOT ready &#8594; Check readiness probe.</div>
<div class="content">
<pre class="highlightjs highlight"><code>oc describe pod/${MYPOD}</code></pre>
</div>
</div>
<div class="listingblock execute">
<div class="title">pod status: NOT pending, but NOT running &#8594; Check for app or image issues.</div>
<div class="content">
<pre class="highlightjs highlight"><code>oc logs pod/${MYPOD}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a node was assigned, check kubelet on the node.</p>
</div>
<div class="paragraph">
<p>(Optional log gathering)</p>
</div>
<div class="listingblock execute">
<div class="title">Document Ceph Cluster health check:</div>
<div class="content">
<pre class="highlightjs highlight"><code>oc adm must-gather --image=registry.redhat.io/ocs4/ocs-must-gather-rhel8:v4.6</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_troubleshooting"><a class="anchor" href="#_troubleshooting"></a>5. Troubleshooting</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Issue encountered while following the SOP</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>Any issues while following the SOP should be documented here.</pre>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">
      <img src="../../_/img/header_logo.svg" alt="Red Hat Data Services">
  </a>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
