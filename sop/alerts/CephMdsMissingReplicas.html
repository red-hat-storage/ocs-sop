<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CephMgrIsAbsent :: OCS Standard Operating Procedures</title>
    <link rel="canonical" href="https://red-hat-storage.github.io/ocs-sop/sop/alerts/CephMdsMissingReplicas.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://red-hat-storage.github.io/ocs-sop">OCS Standard Operating Procedures</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="sop" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">OCS Standard Operating Procedures</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Alerts</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephClusterCriticallyFull.html">CephClusterCriticallyFull</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephClusterErrorState.html">CephClusterErrorState</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephClusterReadOnly.html">CephClusterReadOnly</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephClusterWarningState.html">CephClusterWarningState</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="CephMdsMissingReplicas.html">CephMdsMissingReplicas</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephMgrIsAbsent.html">CephMgrIsAbsent</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephMgrIsMissingReplicas.html">CephMgrIsMissingReplicas</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephMonQuorumAtRisk.html">CephMonQuorumAtRisk</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephMonVersionMismatch.html">CephMonVersionMismatch</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephNodeDown.html">CephNodeDown</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephOSDCriticallyFull.html">CephOSDCriticallyFull</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephOSDDiskNotResponding.html">CephOSDDiskNotResponding</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephOSDDiskUnavailable.html">CephOSDDiskUnavailable</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephOSDNearFull.html">CephOSDNearFull</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephOSDVersionMismatch.html">CephOSDVersionMismatch</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="CephPGRepairTakingTooLong.html">CephPGRepairTakingTooLong</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OCS Standard Operating Procedures</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">OCS Standard Operating Procedures</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">OCS Standard Operating Procedures</a></li>
    <li>Alerts</li>
    <li><a href="CephMdsMissingReplicas.html">CephMdsMissingReplicas</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/red-hat-storage/ocs-sop/edit/main/sop/modules/alerts/pages/CephMdsMissingReplicas.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">CephMgrIsAbsent</h1>
<div id="preamble">
<div class="sectionbody">
<div id="toc" class="toc">
<div id="toctitle" class="title"><b>Table of Contents</b></div>
<ul class="sectlevel1">
<li><a href="#_check_description">1. Check Description</a></li>
<li><a href="#_overview">2. Overview</a></li>
<li><a href="#_prerequsities">3. Prerequsities</a>
<ul class="sectlevel2">
<li><a href="#_prerequisite_1_verify_cluster_access">3.1. Prerequisite 1 - Verify Cluster Access</a></li>
<li><a href="#_prerequisite_3_document_ocs_ceph_cluster_health">3.2. Prerequisite 3 - Document OCS Ceph Cluster Health</a></li>
</ul>
</li>
<li><a href="#_alert">4. Alert</a>
<ul class="sectlevel2">
<li><a href="#_make_changes_to_solve_alert">4.1. Make changes to solve alert</a></li>
</ul>
</li>
<li><a href="#_troubleshooting">5. Troubleshooting</a></li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_check_description"><a class="anchor" href="#_check_description"></a>1. Check Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Severity:</strong> Warning</p>
</div>
<div class="paragraph">
<p><strong>Potential Customer Impact:</strong> High</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_overview"><a class="anchor" href="#_overview"></a>2. Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Minimum required replicas for the storage metadata service (MDS) are not available. MDS is responsible for file metadata. Degradation of the MDS service can affect the working of the storage cluster and should be fixed as soon as possible.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prerequsities"><a class="anchor" href="#_prerequsities"></a>3. Prerequsities</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_prerequisite_1_verify_cluster_access"><a class="anchor" href="#_prerequisite_1_verify_cluster_access"></a>3.1. Prerequisite 1 - Verify Cluster Access</h3>
<div class="listingblock">
<div class="title">Verify cluster access:</div>
<div class="content">
<pre>Find the cluster name in the alert and run:
oc whoami --show-server

Check the output to ensure you are in the correct context for the cluster mentioned in the alert. If not, please change context and proceed.proceed.

=== Prerequisite 2 - Verify Alert

.Verify the alert is still active:</pre>
</div>
</div>
<div class="paragraph">
<p>Get the route to this cluster&#8217;s alertmanager:
MYALERTMANAGER=$(oc -n openshift-monitoring get routes/alertmanager-main --no-headers | awk '{print $2}')</p>
</div>
<div class="paragraph">
<p>Get your alertname from the alert, set for use in jq:
export MYALERTNAME="&lt;alertname from alert&gt;"</p>
</div>
<div class="paragraph">
<p>To see if this single alert is active run:
curl -k -H "Authorization: Bearer $(oc -n openshift-monitoring sa get-token prometheus-k8s)"  <a href="https://${MYALERTMANAGER}/api/v1/alerts" class="bare">https://${MYALERTMANAGER}/api/v1/alerts</a> | jq '.data[] | select( .labels.alertname | test(env.MYALERTNAME)) | { ALERT: .labels.alertname, STATE: .status.state}'</p>
</div>
<div class="paragraph">
<p>No entries means the alert is no longer active. Some alerts, such as mismatch versions, can occur during upgrades and resolve themselves. If this alert is not a mismatch version alert then there should be an investigation into what triggered the alert even though the alert resolved. Look for other active alerts or alerts with similiar timing.</p>
</div>
<div class="paragraph">
<p>If you need more details run:
curl -k -H "Authorization: Bearer $(oc -n openshift-monitoring sa get-token prometheus-k8s)"  <a href="https://${MYALERTMANAGER}/api/v1/alerts" class="bare">https://${MYALERTMANAGER}/api/v1/alerts</a> | jq '.data[] | select( .labels.alertname | test(env.MYALERTNAME)) | { ALERTDETAILS: .}'</p>
</div>
<div class="paragraph">
<p>More about the Prometheus Alert endpoint can be found here:
<a href="https://prometheus.io/docs/prometheus/latest/querying/api/#alerts" class="bare">https://prometheus.io/docs/prometheus/latest/querying/api/#alerts</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_prerequisite_3_document_ocs_ceph_cluster_health"><a class="anchor" href="#_prerequisite_3_document_ocs_ceph_cluster_health"></a>3.2. Prerequisite 3 - Document OCS Ceph Cluster Health</h3>
<div class="listingblock">
<div class="title">Check and document ceph cluster health:</div>
<div class="content">
<pre>Capture output using normal OSD team methods.
TOOLS_POD=$(oc get pods -n openshift-storage -l app=rook-ceph-tools -o name)
oc rsh -n openshift-storage $TOOLS_POD

From the rsh command prompt, run the following and capture the output.
ceph status
ceph osd status
ceph osd tree
ceph df
rados df
ceph versions
exit</pre>
</div>
</div>
<div class="paragraph">
<p>If the toolbox is not deployed, please follow the directions below.
The Rook-Ceph <strong>toolbox</strong> should already be installed for this OCS on OSD cluster. If it is not, we need to deploy it since it is not shipped with OCS.</p>
</div>
<div class="listingblock execute">
<div class="title">Deploy Rook-Ceph toolbox if needed:</div>
<div class="content">
<pre class="highlightjs highlight"><code>oc patch OCSInitialization ocsinit -n openshift-storage --type json --patch  '[{ "op": "replace", "path": "/spec/enableCephTools", "value": true }]'</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_alert"><a class="anchor" href="#_alert"></a>4. Alert</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="title">Document Ceph Cluster health check:</div>
<div class="content">
<pre>For OCS specific results run:
oc adm must-gather --image=registry.redhat.io/ocs4/ocs-must-gather-rhel8:v4.6</pre>
</div>
</div>
<div class="sect2">
<h3 id="_make_changes_to_solve_alert"><a class="anchor" href="#_make_changes_to_solve_alert"></a>4.1. Make changes to solve alert</h3>
<div class="paragraph">
<p><strong>Check for OCS Operator Update</strong></p>
</div>
<div class="paragraph">
<p>WIP CLI does the status of the operator reflect update in progress?
<a href="https://docs.openshift.com/container-platform/4.6/operators/admin/olm-status.html" class="bare">https://docs.openshift.com/container-platform/4.6/operators/admin/olm-status.html</a></p>
</div>
<div class="paragraph">
<p>WIP UI
The cause of the missing replicas must be determined and fixed. Basic troubleshooting starting with operator status all the way to OCP health may be required.</p>
</div>
<div class="paragraph">
<p><strong>OCS Operator Subscription Health:</strong></p>
</div>
<div class="listingblock">
<div class="title">Check the ocs-operator subscription status</div>
<div class="content">
<pre>oc get sub ocs-operator -n openshift-storage  -o json | jq .status.conditions</pre>
</div>
</div>
<div class="paragraph">
<p>Like all operators, the status conditions types are:</p>
</div>
<div class="paragraph">
<p><strong>CatalogSourcesUnhealthy, InstallPlanMissing, InstallPlanPending, InstallPlanFailed</strong></p>
</div>
<div class="paragraph">
<p>The status for each type should be False. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>[
  {
    "lastTransitionTime": "2021-01-26T19:21:37Z",
    "message": "all available catalogsources are healthy",
    "reason": "AllCatalogSourcesHealthy",
    "status": "False",
    "type": "CatalogSourcesUnhealthy"
  }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output above shows a false status for type CatalogSourcesUnHealthly, meaning the catalog sources are healthy.  WIP insert basic cluster health/resources check?</p>
</div>
<div class="paragraph">
<p><strong>OCS Operator Pod Health:</strong></p>
</div>
<div class="paragraph">
<p>Check the OCS operator pod status to see if there is an OCS operator upgrading in progress.</p>
</div>
<div class="listingblock">
<div class="title">Find and view the status of the OCS operator: WIP Is Upgrade a status or only pending?</div>
<div class="content">
<pre>% oc get pod -n openshift-storage | grep ocs-operator
% OCSOP=$(oc get pod -n openshift-storage  -o custom-columns=POD:.metadata.name --no-headers | grep ocs-operator)
% echo $OCSOP
% oc get pod/${OCSOP} -n openshift-storage
% oc describe pod/${OCSOP} -n openshift-storage</pre>
</div>
</div>
<div class="paragraph">
<p>If you determine the OCS operator is in progress, please be patient, wait 5 minutes and this alert should resolve itself.</p>
</div>
<div class="paragraph">
<p>If you have waited or see a different error status condition, please continue troubleshooting.</p>
</div>
<div class="listingblock">
<div class="title">pod status: NOT pending, running, but NOT ready &#8594; Check readiness probe.</div>
<div class="content">
<pre>oc describe pod/${MYPOD}</pre>
</div>
</div>
<div class="listingblock">
<div class="title">pod status: NOT pending, but NOT running &#8594; Check for app or image issues.</div>
<div class="content">
<pre>oc logs pod/${MYPOD}
oc describe pod/${MYPOD}</pre>
</div>
</div>
<div class="paragraph">
<p>If you are at this step, then the pod is ok. Proceed to check the service.</p>
</div>
<div class="listingblock">
<div class="title">pod status: NOT pending, running, ready, no access to app &#8594; Start debug workflow for service.</div>
<div class="content">
<pre></pre>
</div>
</div>
<div class="listingblock">
<div class="title">pod status: pending &#8594; Check for resource issues, pending pvcs, node assignment, kubelet problems.</div>
<div class="content">
<pre>oc get pod | grep rook-ceph-mds
# Examine the output for a rook-ceph-mds that is in the pending state, not running or not ready
MYPOD=&lt;pod identified as the problem pod&gt;
oc describe pod/${MYPOD}</pre>
</div>
</div>
<div class="paragraph">
<p>Look for resource limitations or pending pvcs. Otherwise, check for node assignment.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>oc get pod/${MYPOD} -o wide</pre>
</div>
</div>
<div class="paragraph">
<p>If a node was assigned, check kubelet on the node.</p>
</div>
<div class="listingblock">
<div class="title">Get pod status:</div>
<div class="content">
<pre>oc project openshift-storage
oc get pod | grep rook-ceph-mds</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_troubleshooting"><a class="anchor" href="#_troubleshooting"></a>5. Troubleshooting</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Issue encountered while following the sop</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>Any issues while following the sop should be documented here.</pre>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
